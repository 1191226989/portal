<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3">
<meta httpequiv="x-ua-compatible" content="ie=edge">
<meta property="og:type" content="website">
<meta name="author" content="zeromicro">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link href="https://www.googletagmanager.com" rel="dns-prefetch">
<link href="https://www.google-analytics.com" rel="dns-prefetch">
<link rel="icon" href="https://go-zero.dev/favicon.png">
<link rel="icon" href="https://go-zero.dev/favicon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="https://go-zero.dev/img/icons/apple-180x180.png" sizes="180x180">
<meta name="msapplication-config" content="/browserconfig.xml">
<link rel="sitemap" type="application/xml" href="/sitemap.xml">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="go-zero Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="go-zero Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XZD0YKV3XQ"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XZD0YKV3XQ",{anonymize_ip:!0})</script>
<link rel="manifest" href="//manifest.webmanifest">
<meta name="theme-color" content="#d14671">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#21222c"><title data-react-helmet="true">Rapid development of microservices | go-zero</title><meta data-react-helmet="true" property="og:image" content><meta data-react-helmet="true" name="twitter:image" content><meta data-react-helmet="true" name="twitter:description" content="go-zero 是一个集成了各种工程实践的 web 和 rpc 框架。通过弹性设计保障了大并发服务端的稳定性，经受了充分的实战检验。"><meta data-react-helmet="true" name="twitter:title" content="Introduction | go-zero"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for &quot;Introduction | go-zero&quot;"><meta data-react-helmet="true" property="og:title" content="Rapid development of microservices | go-zero"><meta data-react-helmet="true" name="description" content="0. Why building microservices are so difficult"><meta data-react-helmet="true" property="og:description" content="0. Why building microservices are so difficult"><link rel="stylesheet" href="/assets/css/styles.fb93b395.css">
</head>
<body itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="">
<meta itemprop="description" content="go-zero 是一个集成了各种工程实践的 web 和 rpc 框架。通过弹性设计保障了大并发服务端的稳定性，经受了充分的实战检验。">
<meta itemprop="url" content="https://go-zero.dev">
<meta itemprop="logo" content="https://go-zero.dev/img/favicon.png">
<meta itemprop="sameAs" content="https://github.com/zeromicro">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar_wBc8 navbar--light navbar--fixed-top"><div class="navbar__inner inner_Y8Z6"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="brand_AtiA" href="/"><img alt="logo" height="30" src="/img/navbar/logo.svg" class="brand_logo_MqNk"><a class="navbar__brand brand_name_O39n">go-zero</a></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/prepare/prepare">Preparation</a></li><li><a class="dropdown__link" href="/docs/quick-start/quick-start">Getting Started</a></li><li><a class="dropdown__link" href="/docs/advance/advance">Guides</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" sidebarid="goctl">goctl</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/goctl/installation">Installation</a></li><li><a class="dropdown__link" href="/docs/goctl/api">API Command</a></li><li><a class="dropdown__link" href="/docs/goctl/zrpc">RPC Command</a></li><li><a class="dropdown__link" href="/docs/goctl/model">Model Command</a></li><li><a class="dropdown__link" href="/docs/goctl/completion">Completion</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">Tool</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/eco/plugins">Goctl Plugin</a></li><li><a class="dropdown__link" href="/docs/eco/editor">Editor Plugin</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">Community</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/community/about-us">About us</a></li><li><a class="dropdown__link" href="/docs/community/showcase">Showcase</a></li><li><a class="dropdown__link" href="/docs/community/contribute">Contributing</a></li><li><a class="dropdown__link" href="/docs/community/contributor">Contributor</a></li><li><a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer" class="dropdown__link">GitHub</a></li><li><a href="https://discord.gg/4JQvC5A4Fe" target="_blank" rel="noopener noreferrer" class="dropdown__link">Discord</a></li></ul></div><a class="navbar__item navbar__link" sidebarid="blog" href="/docs/blog/blog">Blog</a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">More</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/resource-center/learning-resource">Resource Center</a></li><li><a href="https://space.bilibili.com/389552232/channel/seriesdetail?sid=2122723" target="_blank" rel="noopener noreferrer" class="dropdown__link">Video Tutorial</a></li><li><a href="https://github.com/zeromicro/go-zero/blob/master/ROADMAP.md" target="_blank" rel="noopener noreferrer" class="dropdown__link">Development Roadmap</a></li><li><a class="dropdown__link" href="/docs/design/design">Design Docs</a></li><li><a class="dropdown__link" href="/docs/faq/troubleshooting">FAQ</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="searchWrapper_f8aU"><div class="navbar__search searchBarContainer_I7kZ"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_Zg7X searchBarLoadingRing_J5Ez"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_CDc6"><kbd class="searchHint_2RRg">ctrl</kbd><kbd class="searchHint_2RRg">K</kbd></div></div></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/docs/blog/showcase/shorturl" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a href="/cn/docs/blog/showcase/shorturl" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">中文简体</a></li></ul></div><a href="https://github.com/zeromicro/go-zero" class="navbar__items navbar__items--right"><img alt="forks" height="30" src="/img/navbar/github.svg" class="star__fork_dBtt"><div class="star_fork_layout_ROo5"><img alt="stars" height="20" src="https://img.shields.io/github/stars/zeromicro/go-zero?style=social" class="star__fork_dBtt"><img alt="forks" height="20" src="https://img.shields.io/github/forks/zeromicro/go-zero?style=social" class="star__fork_dBtt"></div></a><div class="react-toggle themeToggleInHeading_b3Mq react-toggle--checked react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_iYfV" style="margin-left:2px">🌙</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV" style="margin-left:1px">☀</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand brand_AtiA" href="/">go-zero</a><div class="react-toggle themeToggleInSidebar_qGRI react-toggle--checked react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_iYfV" style="margin-left:2px">🌙</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV" style="margin-left:1px">☀</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a href="#" role="button" class="menu__link menu__link--sublist"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>Languages</span></span></a><ul class="menu__list"><li class="menu__list-item"><a href="/docs/blog/showcase/shorturl" target="_self" rel="noopener noreferrer" class="menu__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li class="menu__list-item"><a href="/cn/docs/blog/showcase/shorturl" target="_self" rel="noopener noreferrer" class="menu__link" style="text-transform:capitalize">中文简体</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">Docs</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/prepare/prepare">Preparation</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/quick-start/quick-start">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/advance/advance">Guides</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist" sidebarid="goctl">goctl</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/goctl/installation">Installation</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/goctl/api">API Command</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/goctl/zrpc">RPC Command</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/goctl/model">Model Command</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/goctl/completion">Completion</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">Tool</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/eco/plugins">Goctl Plugin</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/eco/editor">Editor Plugin</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">Community</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/community/about-us">About us</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/community/showcase">Showcase</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/community/contribute">Contributing</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/community/contributor">Contributor</a></li><li class="menu__list-item"><a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://discord.gg/4JQvC5A4Fe" target="_blank" rel="noopener noreferrer" class="menu__link">Discord</a></li></ul></li><li class="menu__list-item"><a class="menu__link" sidebarid="blog" href="/docs/blog/blog">Blog</a></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">More</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/resource-center/learning-resource">Resource Center</a></li><li class="menu__list-item"><a href="https://space.bilibili.com/389552232/channel/seriesdetail?sid=2122723" target="_blank" rel="noopener noreferrer" class="menu__link">Video Tutorial</a></li><li class="menu__list-item"><a href="https://github.com/zeromicro/go-zero/blob/master/ROADMAP.md" target="_blank" rel="noopener noreferrer" class="menu__link">Development Roadmap</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/design/design">Design Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/faq/troubleshooting">FAQ</a></li></ul></li></ul></div></div></div></nav><div class="wrapper_DIJ0"><div class="doc_D+rh"><div class="doc__sidebar_gVFN" role="complementary"><div class="sidebar_LIo8"><div class="menu menu--responsive thin-scrollbar menu_oAhv"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_nrF-" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" href="/docs/blog/blog">Blog</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">Governance</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/governance/bloom">Bloom Filter</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/governance/breaker-algorithms">Fusing Principle and Implementation</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/governance/loadshedding">Load Shedding</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/governance/periodlimit">Period Limit</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/governance/tokenlimit">Token Limit</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">Cache</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/cache/cache">DB caching mechanism</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/cache/redis-cache">go-zero cache design for persistence layer cache</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/cache/business-cache">go-zero cache design for business-level caching</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/cache/collection">Caching via collection</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">Components</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/tool/executors">Executors</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/tool/keywords">Efficient keyword replacement and sensitive word filtering tool</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/tool/logx">logx</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">Concurrency</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/concurrency/fx">Fx</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/concurrency/mapreduce">Mapreduce</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/concurrency/stream">Stream processing</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/concurrency/redis-lock">Redis Lock</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/concurrency/sharedcalls">SharedCalls</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">Principle</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/principle/timing-wheel">TimingWheel</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u menu__link--sublist menu__link--active" href="#!">Showcase</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menuLink_Zq3u menu__link--active active" tabindex="0" href="/docs/blog/showcase/shorturl">Rapid development of microservices</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="0" href="/docs/blog/showcase/zrpc">Enterprise RPC framework zRPC</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="0" href="/docs/blog/showcase/mysql">Mysql</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="0" href="/docs/blog/showcase/mapping">Mapping</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="0" href="/docs/blog/showcase/datacenter">Data center</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="0" href="/docs/blog/showcase/go-queue">Queue</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="0" href="/docs/blog/showcase/go-zero-looklook">Develop a travel system using go-zero go-zero-looklook</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="0" href="/docs/blog/showcase/metric">Microservice metrics monitoring based on prometheus</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">Exchange</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/docs/blog/share/online-exchange">Online Communication on October 3,2020</a></li></ul></li></ul></div></div></div><main class="doc__main_VklL"><div class="padding-vert--lg container doc__item-wrapper_FIxd"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><header><h1 class="docTitle_-X99">Rapid development of microservices</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="0-why-building-microservices-are-so-difficult"></a>0. Why building microservices are so difficult<a class="hash-link" href="#0-why-building-microservices-are-so-difficult" title="Direct link to heading">#</a></h2><p>To build a well working microservice, we need lots of knowledges from different aspects.</p><ul><li><p>basic functionalities</p><ol><li>concurrency control and rate limit, to avoid being brought down by unexpected inbound</li><li>service discovery, make sure new or terminated nodes are detected asap</li><li>load balancing, balance the traffic base on the throughput of nodes</li><li>timeout control, avoid the nodes continue to process the timed out requests</li><li>circuit breaker, load shedding, fail fast, protects the failure nodes to recover asap</li></ol></li><li><p>advanced functionalities</p><ol><li>authorization, make sure users can only access their own data</li><li>tracing, to understand the whole system and locate the specific problem quickly</li><li>logging, collects data and helps to backtrace problems</li><li>observability, no metrics, no optimization</li></ol></li></ul><p>For any point listed above, we need a long article to describe the theory and the implementation. But for us, the developers, it’s very difficult to understand all the concepts and make it happen in our systems. Although, we can use the frameworks that have been well served busy sites. <a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer">go-zero</a> is born for this purpose, especially for cloud-native microservice systems.</p><p>As well, we always adhere to the idea that <strong>prefer tools over conventions and documents</strong>. We hope to reduce the boilerplate code as much as possible, and let developers focus on developing the business related code. For this purpose, we developed the tool  <code>goctl</code>.</p><p>Let’s take the shorturl microservice as a quick example to demonstrate how to quickly create microservices by using <a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer">go-zero</a>. After finishing this tutorial, you’ll find that it’s so easy to write microservices!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1-what-is-a-shorturl-service"></a>1. What is a shorturl service<a class="hash-link" href="#1-what-is-a-shorturl-service" title="Direct link to heading">#</a></h2><p>A shorturl service is that it converts a long url into a short one, by well designed algorithms.</p><p>Writting this shorturl service is to demonstrate the complete flow of creating a microservice by using go-zero. But algorithms and detail implementations are quite simplified, and this shorturl service is not suitable for production use.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-architecture-of-shorturl-microservice"></a>2. Architecture of shorturl microservice<a class="hash-link" href="#2-architecture-of-shorturl-microservice" title="Direct link to heading">#</a></h2><img src="https://raw.githubusercontent.com/zeromicro/zero-doc/main/doc/images/shorturl-arch.png" alt="架构图" width="800"><ul><li>In this tutorial, I only use one rpc service, transform, to demonstrate. It’s not telling that one API Gateway only can call one RPC service, it’s only for simplicity here.</li><li>In production, we should try best to isolate the data belongs to services, that means each service should only use its own database.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="3-goctl-generated-code-overview"></a>3. goctl generated code overview<a class="hash-link" href="#3-goctl-generated-code-overview" title="Direct link to heading">#</a></h2><p>All modules with green background are generated, and will be enabled when necessary. The modules with red background are handwritten code, which is typically business logic code.</p><ul><li><p>API Gateway</p><img src="https://raw.githubusercontent.com/zeromicro/zero-doc/main/doc/images/shorturl-api.png" alt="api" width="800"></li><li><p>RPC</p><img src="https://raw.githubusercontent.com/zeromicro/zero-doc/main/doc/images/shorturl-rpc.png" alt="架构图" width="800"></li><li><p>model</p><img src="https://raw.githubusercontent.com/zeromicro/zero-doc/main/doc/images/shorturl-model.png" alt="model" width="800"></li></ul><p>And now, let’s walk through the complete flow of quickly create a microservice with go-zero.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="4-get-started"></a>4. Get started<a class="hash-link" href="#4-get-started" title="Direct link to heading">#</a></h2><ul><li><p>install etcd, mysql, redis</p></li><li><p>install protoc-gen-go</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go-zero"><div tabindex="0" class="prism-code language-go-zero codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">go get -u github.com/golang/protobuf/protoc-gen-go@v1.3.2</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div></li><li><p>install goctl</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token assign-left variable" style="color:#ff79c6">GO111MODULE</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">on go get -u github.com/zeromicro/go-zero/tools/goctl</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div></li><li><p>create the working dir <code>shorturl</code> and <code>shorturl/api</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go-zero"><div tabindex="0" class="prism-code language-go-zero codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">mkdir -p shorturl/api</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div></li><li><p>in <code>shorturl</code> dir, execute <code>go mod init shorturl</code> to initialize <code>go.mod</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go-zero"><div tabindex="0" class="prism-code language-go-zero codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">module shorturl</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">go 1.15</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">require (</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  github.com/golang/mock v1.4.3</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  github.com/golang/protobuf v1.4.2</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  github.com/zeromicro/go-zero v1.3.0</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  golang.org/x/net v0.0.0-20200707034311-ab3426394381</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  google.golang.org/grpc v1.29.1</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">)</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="5-write-code-for-api-gateway"></a>5. Write code for API Gateway<a class="hash-link" href="#5-write-code-for-api-gateway" title="Direct link to heading">#</a></h2><ul><li><p>use goctl to generate <code>api/shorturl.api</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">goctl api -o shorturl.api</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>for simplicity, the leading <code>info</code> block is removed, and the code looks like:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    expandReq </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        shorten </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">`form:&quot;shorten&quot;`</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    expandResp </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        url </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">`json:&quot;url&quot;`</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    shortenReq </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        url </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">`form:&quot;url&quot;`</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    shortenResp </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        shorten </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">`json:&quot;shorten&quot;`</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">service shorturl</span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain">api </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    @</span><span class="token function" style="color:#8be9fd">server</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        handler</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> ShortenHandler</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    get </span><span class="token operator" style="color:#ff79c6">/</span><span class="token function" style="color:#8be9fd">shorten</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">shortenReq</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">returns</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">shortenResp</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    @</span><span class="token function" style="color:#8be9fd">server</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        handler</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> ExpandHandler</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    get </span><span class="token operator" style="color:#ff79c6">/</span><span class="token function" style="color:#8be9fd">expand</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">expandReq</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">returns</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">expandResp</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>the usage of <code>type</code> keyword is the same as that in go, service is used to define get/post/head/delete api requests, described below:</p><ul><li><code>service shorturl-api {</code> defines the service name</li><li><code>@server</code> defines the properties that used in server side</li><li><code>handler</code> defines the handler name</li><li><code>get /shorten(shortenReq) returns(shortenResp)</code> defines this is a GET request, the request parameters, and the response parameters</li></ul></li><li><p>generate the code for API Gateway by using goctl</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">goctl api go -api shorturl.api -dir </span><span class="token builtin class-name" style="color:#bd93f9">.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>the generated file structure looks like:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Plain"><div tabindex="0" class="prism-code language-Plain codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">.</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">├── api</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   ├── etc</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │   └── shorturl-api.yaml         // configuration file</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   ├── internal</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │   ├── config</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │   │   └── config.go             // configuration definition</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │   ├── handler</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │   │   ├── expandhandler.go      // implements expandHandler</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │   │   ├── routes.go             // routes definition</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │   │   └── shortenhandler.go     // implements shortenHandler</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │   ├── logic</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │   │   ├── expandlogic.go        // implements ExpandLogic</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │   │   └── shortenlogic.go       // implements ShortenLogic</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │   ├── svc</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │   │   └── servicecontext.go     // defines ServiceContext</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │   └── types</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │       └── types.go              // defines request/response</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   ├── shorturl.api</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   └── shorturl.go                   // main entrance</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">├── go.mod</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">└── go.sum</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div></li><li><p>start API Gateway service, listens on port 8888 by default</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">go run shorturl.go -f etc/shorturl-api.yaml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div></li><li><p>test API Gateway service</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token function" style="color:#8be9fd">curl</span><span class="token plain"> -i </span><span class="token string" style="color:#f1fa8c">&quot;http://localhost:8888/shorten?url=http://www.xiaoheiban.cn&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>response like:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI http"><div tabindex="0" class="prism-code language-http codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">HTTP/1.1 200 OK</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">Content-Type: application/json</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">Date: Thu, 27 Aug 2020 14:31:39 GMT</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">Content-Length: 15</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">{&quot;shortUrl&quot;:&quot;&quot;}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>You can see that the API Gateway service did nothing except returned a zero value. And let’s implement the business logic in rpc service.</p></li><li><p>you can modify <code>internal/svc/servicecontext.go</code> to pass dependencies if needed</p></li><li><p>implement logic in package <code>internal/logic</code></p></li><li><p>you can use goctl to generate code for clients base on the .api file</p></li><li><p>till now, the client engineer can work with the api, don’t need to wait for the implementation of server side</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="6-write-code-for-transform-rpc-service"></a>6. Write code for transform rpc service<a class="hash-link" href="#6-write-code-for-transform-rpc-service" title="Direct link to heading">#</a></h2><ul><li>under directory <code>shorturl</code> create dir <code>rpc</code></li></ul><ul><li><p>under directory <code>rpc/transform</code> create <code>transform.proto</code> file</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">goctl rpc template -o transform.proto</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>edit the file and make the code looks like:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI protobuf"><div tabindex="0" class="prism-code language-protobuf codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">syntax = &quot;proto3&quot;;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">package transform;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">message expandReq {</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    string shorten = 1;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">}</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">message expandResp {</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    string url = 1;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">}</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">message shortenReq {</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    string url = 1;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">}</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">message shortenResp {</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    string shorten = 1;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">}</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">service transformer {</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    rpc expand(expandReq) returns(expandResp);</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    rpc shorten(shortenReq) returns(shortenResp);</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div></li><li><p>use goctl to generate the rpc code, execute the following command in <code>rpc/transofrm</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">goctl rpc proto -src transform.proto -dir </span><span class="token builtin class-name" style="color:#bd93f9">.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>the generated file structure looks like:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Plain"><div tabindex="0" class="prism-code language-Plain codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">rpc/transform</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">├── etc</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   └── transform.yaml              // configuration file</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">├── internal</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   ├── config</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │   └── config.go               // configuration definition</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   ├── logic</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │   ├── expandlogic.go          // implements expand logic</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │   └── shortenlogic.go         // implements shorten logic</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   ├── server</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   │   └── transformerserver.go    // rpc handler</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   └── svc</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│       └── servicecontext.go       // defines service context, like dependencies</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">├── pb</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">│   └── transform.pb.go</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">├── transform.go                    // rpc main entrance</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">├── transform.proto</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">└── transformer</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    ├── transformer.go              // defines how rpc clients call this service</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    ├── transformer_mock.go         // mock file, for test purpose</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    └── types.go                    // request/response definition</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>just run it, looks like:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">$ go run transform.go -f etc/transform.yaml</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">Starting rpc server at </span><span class="token number" style="color:#50fa7b">127.0</span><span class="token plain">.0.1:8080</span><span class="token punctuation" style="color:#f8f8f2">..</span><span class="token plain">.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>you can change the listening port in file <code>etc/transform.yaml</code>.</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="7-modify-api-gateway-to-call-transform-rpc-service"></a>7. Modify API Gateway to call transform rpc service<a class="hash-link" href="#7-modify-api-gateway-to-call-transform-rpc-service" title="Direct link to heading">#</a></h2><ul><li><p>modify the configuration file <code>shorturl-api.yaml</code>, add the following:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token key atrule">Transform</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">Etcd</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">Hosts</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> localhost</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token number" style="color:#50fa7b">2379</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token key atrule">Key</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> transform.rpc</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>automatically discover the transform service by using etcd.</p></li><li><p>modify the file <code>internal/config/config.go</code>, add dependency on transform service:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">type</span><span class="token plain"> Config </span><span class="token keyword" style="color:#ff79c6">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    rest</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">RestConf</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    Transform zrpc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">RpcClientConf     </span><span class="token comment" style="color:#6272a4">// manual code</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div></li><li><p>modify the file <code>internal/svc/servicecontext.go</code>, like below:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">type</span><span class="token plain"> ServiceContext </span><span class="token keyword" style="color:#ff79c6">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    Config    config</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Config</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    Transformer transformer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Transformer  </span><span class="token comment" style="color:#6272a4">// manual code</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">NewServiceContext</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">c config</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">ServiceContext </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">ServiceContext</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        Config</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">    c</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    Transformer</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> transformer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">NewTransformer</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">zrpc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">MustNewClient</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Transform</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token comment" style="color:#6272a4">// manual code</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>passing the dependencies among services within ServiceContext.</p></li><li><p>modify the method <code>Expand</code> in the file <code>internal/logic/expandlogic.go</code>, looks like:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">l </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">ExpandLogic</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">Expand</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">req types</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ExpandReq</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">types</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ExpandResp</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// manual code start</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    resp</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> l</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">svcCtx</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Transformer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Expand</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">l</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">transformer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ExpandReq</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        Shorten</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> req</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Shorten</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">types</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ExpandResp</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        Url</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> resp</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Url</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// manual code stop</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>by calling the method <code>Expand</code> of <code>transformer</code> to restore the shortened url.</p></li><li><p>modify the file <code>internal/logic/shortenlogic.go</code>, looks like:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">l </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">ShortenLogic</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">Shorten</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">req types</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ShortenReq</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">types</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ShortenResp</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// manual code start</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    resp</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> l</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">svcCtx</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Transformer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Shorten</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">l</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">transformer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ShortenReq</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        Url</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> req</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Url</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">types</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ShortenResp</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        Shorten</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> resp</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Shorten</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// manual code stop</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>by calling the method <code>Shorten</code> of <code>transformer</code> to shorten the url.</p></li></ul><p>Till now, we’ve done the modification of API Gateway. All the manually added code are marked.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="8-define-the-database-schema-generate-the-code-for-crudcache"></a>8. Define the database schema, generate the code for CRUD+cache<a class="hash-link" href="#8-define-the-database-schema-generate-the-code-for-crudcache" title="Direct link to heading">#</a></h2><ul><li><p>under shorturl, create the directory <code>rpc/transform/model</code>: <code>mkdir -p rpc/transform/model</code></p></li><li><p>under the directory rpc/transform/model create the file called shorturl.sql`, contents as below:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI sql"><div tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">TABLE</span><span class="token plain"> </span><span class="token identifier punctuation" style="color:#f8f8f2">`</span><span class="token identifier">shorturl</span><span class="token identifier punctuation" style="color:#f8f8f2">`</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#f8f8f2">`</span><span class="token identifier">shorten</span><span class="token identifier punctuation" style="color:#f8f8f2">`</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">varchar</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#50fa7b">255</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&#x27;shorten key&#x27;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token identifier punctuation" style="color:#f8f8f2">`</span><span class="token identifier">url</span><span class="token identifier punctuation" style="color:#f8f8f2">`</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">varchar</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#50fa7b">255</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">NULL</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">COMMENT</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&#x27;original url&#x27;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">KEY</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token identifier punctuation" style="color:#f8f8f2">`</span><span class="token identifier">shorten</span><span class="token identifier punctuation" style="color:#f8f8f2">`</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">ENGINE</span><span class="token operator" style="color:#ff79c6">=</span><span class="token keyword" style="color:#ff79c6">InnoDB</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">CHARSET</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">utf8mb4</span><span class="token punctuation" style="color:#f8f8f2">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div></li><li><p>create DB and table</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI sql"><div tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">create</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">database</span><span class="token plain"> gozero</span><span class="token punctuation" style="color:#f8f8f2">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI sql"><div tabindex="0" class="prism-code language-sql codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">source shorturl</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token keyword" style="color:#ff79c6">sql</span><span class="token punctuation" style="color:#f8f8f2">;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div></li><li><p>under the directory <code>rpc/transform/model</code> execute the following command to genrate CRUD+cache code, <code>-c</code> means using <code>redis cache</code></p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">goctl model mysql ddl -c -src shorturl.sql -dir </span><span class="token builtin class-name" style="color:#bd93f9">.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>you can also generate the code from the database url by using <code>datasource</code> subcommand instead of <code>ddl</code></p><p>the generated file structure looks like:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI Plain"><div tabindex="0" class="prism-code language-Plain codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">rpc/transform/model</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">├── shorturl.sql</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">├── shorturlmodel.go              // CRUD+cache code</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">└── vars.go                       // const and var definition</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="9-modify-shortenexpand-rpc-to-call-crudcache"></a>9. Modify shorten/expand rpc to call crud+cache<a class="hash-link" href="#9-modify-shortenexpand-rpc-to-call-crudcache" title="Direct link to heading">#</a></h2><ul><li><p>modify <code>rpc/transform/etc/transform.yaml</code>, add the following:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token key atrule">DataSource</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> root</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">@tcp(localhost</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">3306)/gozero</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">Table</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> shorturl</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">Cache</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> </span><span class="token key atrule">Host</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> localhost</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token number" style="color:#50fa7b">6379</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>you can use multiple redis as cache. redis node and cluster are both supported.</p></li><li><p>modify <code>rpc/transform/internal/config.go</code>, like below:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">type</span><span class="token plain"> Config </span><span class="token keyword" style="color:#ff79c6">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    zrpc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">RpcServerConf</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    DataSource </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token plain">             </span><span class="token comment" style="color:#6272a4">// manual code</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    Table      </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token plain">             </span><span class="token comment" style="color:#6272a4">// manual code</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    Cache      cache</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">CacheConf    </span><span class="token comment" style="color:#6272a4">// manual code</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>added the configuration for mysql and redis cache.</p></li><li><p>modify <code>rpc/transform/internal/svc/servicecontext.go</code>, like below:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">type</span><span class="token plain"> ServiceContext </span><span class="token keyword" style="color:#ff79c6">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  c     config</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Config</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  Model model</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ShorturlModel   </span><span class="token comment" style="color:#6272a4">// manual code</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">NewServiceContext</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">c config</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">ServiceContext </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">ServiceContext</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        c</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">             c</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        Model</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> model</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">NewShorturlModel</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">sqlx</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">NewMysql</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">DataSource</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Cache</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token comment" style="color:#6272a4">// manual code</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div></li><li><p>modify <code>rpc/transform/internal/logic/expandlogic.go</code>, like below:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">l </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">ExpandLogic</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">Expand</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">in </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">transform</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ExpandReq</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">transform</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ExpandResp</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// manual code start</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    res</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> l</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">svcCtx</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Model</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">FindOne</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">l</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> in</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Shorten</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">transform</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ExpandResp</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        Url</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> res</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Url</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// manual code stop</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div></li><li><p>modify <code>rpc/shorten/internal/logic/shortenlogic.go</code>, looks like:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">l </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">ShortenLogic</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">Shorten</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">in </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">transform</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ShortenReq</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">transform</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ShortenResp</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// manual code start, generates shorturl</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  key </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> hash</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Md5Hex</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token function" style="color:#8be9fd">byte</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">in</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Url</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token number" style="color:#50fa7b">6</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  object</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">_</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> l</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">svcCtx</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Model</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">FindOne</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">l</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> object </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">transform</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ShortenResp</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      Shorten</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> key</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token boolean" style="color:#bd93f9">_</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> l</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">svcCtx</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Model</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Insert</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">l</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">model</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Shorturl</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        Shorten</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> key</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        Url</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">     in</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Url</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">transform</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ShortenResp</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        Shorten</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> key</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// manual code stop</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>till now, we finished modifing the code, all the modified code is marked.</p></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="10-call-shorten-and-expand-services"></a>10. Call shorten and expand services<a class="hash-link" href="#10-call-shorten-and-expand-services" title="Direct link to heading">#</a></h2><ul><li><p>call shorten api</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token function" style="color:#8be9fd">curl</span><span class="token plain"> -i </span><span class="token string" style="color:#f1fa8c">&quot;http://localhost:8888/shorten?url=http://www.xiaoheiban.cn&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>response like:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI http"><div tabindex="0" class="prism-code language-http codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">HTTP/1.1 200 OK</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">Content-Type: application/json</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">Date: Sat, 29 Aug 2020 10:49:49 GMT</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">Content-Length: 21</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">{&quot;shorten&quot;:&quot;f35b2a&quot;}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div></li><li><p>call expand api</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token function" style="color:#8be9fd">curl</span><span class="token plain"> -i </span><span class="token string" style="color:#f1fa8c">&quot;http://localhost:8888/expand?shorten=f35b2a&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div><p>response like:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI http"><div tabindex="0" class="prism-code language-http codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">HTTP/1.1 200 OK</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">Content-Type: application/json</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">Date: Sat, 29 Aug 2020 10:51:53 GMT</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">Content-Length: 34</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">{&quot;url&quot;:&quot;http://www.xiaoheiban.cn&quot;}</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB">Copy</button></div></div></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="11-benchmark"></a>11. Benchmark<a class="hash-link" href="#11-benchmark" title="Direct link to heading">#</a></h2><p>Because benchmarking the write requests depends on the write throughput of mysql, we only benchmarked the expand api. We read the data from mysql and cache it in redis. I chose 100 hot keys hardcoded in shorten.lua to generate the benchmark.</p><p><img src="https://raw.githubusercontent.com/zeromicro/zero-doc/main/doc/images/shorturl-benchmark.png" alt="Benchmark"></p><p>as shown above, in my MacBook Pro, the QPS is like 30K+.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="12-full-code"></a>12. Full code<a class="hash-link" href="#12-full-code" title="Direct link to heading">#</a></h2><p><a href="https://github.com/zeromicro/zero-examples/tree/main/shorturl" target="_blank" rel="noopener noreferrer">https://github.com/zeromicro/zero-examples/tree/main/shorturl</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="13-conclusion"></a>13. Conclusion<a class="hash-link" href="#13-conclusion" title="Direct link to heading">#</a></h2><p>We always adhere to <strong>prefer tools over conventions and documents</strong>.</p><p>go-zero is not only a framework, but also a tool to simplify and standardize the building of micoservice systems.</p><p>We not only keep the framework simple, but also encapsulate the complexity into the framework. And the developers are free from building the difficult and boilerplate code. Then we get the rapid development and less failure.</p><p>For the generated code by goctl, lots of microservice components are included, like concurrency control, adaptive circuit breaker, adaptive load shedding, auto cache control etc. And it’s easy to deal with the busy sites.</p><p>If you have any ideas that can help us to improve the productivity, tell me any time! 👏</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/zeromicro/portal/edit/main/docs/blog/showcase/shorturl.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col text--right"><em><small>Last updated on <time datetime="2022-05-04T15:18:52.000Z" class="lastUpdatedDate_nN9m">5/4/2022</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/blog/principle/timing-wheel"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« TimingWheel</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/blog/showcase/zrpc"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Enterprise RPC framework zRPC »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#0-why-building-microservices-are-so-difficult" class="table-of-contents__link">0. Why building microservices are so difficult</a></li><li><a href="#1-what-is-a-shorturl-service" class="table-of-contents__link">1. What is a shorturl service</a></li><li><a href="#2-architecture-of-shorturl-microservice" class="table-of-contents__link">2. Architecture of shorturl microservice</a></li><li><a href="#3-goctl-generated-code-overview" class="table-of-contents__link">3. goctl generated code overview</a></li><li><a href="#4-get-started" class="table-of-contents__link">4. Get started</a></li><li><a href="#5-write-code-for-api-gateway" class="table-of-contents__link">5. Write code for API Gateway</a></li><li><a href="#6-write-code-for-transform-rpc-service" class="table-of-contents__link">6. Write code for transform rpc service</a></li><li><a href="#7-modify-api-gateway-to-call-transform-rpc-service" class="table-of-contents__link">7. Modify API Gateway to call transform rpc service</a></li><li><a href="#8-define-the-database-schema-generate-the-code-for-crudcache" class="table-of-contents__link">8. Define the database schema, generate the code for CRUD+cache</a></li><li><a href="#9-modify-shortenexpand-rpc-to-call-crudcache" class="table-of-contents__link">9. Modify shorten/expand rpc to call crud+cache</a></li><li><a href="#10-call-shorten-and-expand-services" class="table-of-contents__link">10. Call shorten and expand services</a></li><li><a href="#11-benchmark" class="table-of-contents__link">11. Benchmark</a></li><li><a href="#12-full-code" class="table-of-contents__link">12. Full code</a></li><li><a href="#13-conclusion" class="table-of-contents__link">13. Conclusion</a></li></ul></div></div></div></div></main></div></div><footer class="footer_rm3y section_bQ6r"><div class="footer__inner_OWoZ section--inner_6-fB"><div class="footer__column_+a5z footer__column--left_4bpB"><div><img alt="go-zero logo" class="footer__logo_ayM4" height="27" src="/img/footer/go-zero.svg" title="go-zero" width="108"><img alt="stars" height="27" src="https://img.shields.io/github/stars/zeromicro/go-zero?style=social" class="footer__logo_ayM4"><img alt="forks" height="27" src="https://img.shields.io/github/forks/zeromicro/go-zero?style=social" class="footer__logo_ayM4"></div><p class="footer__tagline_b1u+">go-zero is a web and rpc framework that with lots of engineering practices builtin</p><a class="footer__github_okz3 button_f7Ff button--icon_q89D button--secondary_x3vq button--xsmall_fwzy" href="https://github.com/zeromicro/go-zero" rel="noopener noreferrer" target="_blank"><img alt="GitHub logo" height="22" src="/img/github.svg" title="GitHub" width="22">Star us on GitHub</a></div><div class="footer__column_+a5z footer__column--right_FGdI"><div class="footer__links_5pu0"><ul class="footer__items_3d9P"><li class="footer__title_ulcL">zeromicro</li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/zero-api" rel="noopener noreferrer" target="_blank">zero-api</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/go-queue" rel="noopener noreferrer" target="_blank">go-queue</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/awesome-zero" rel="noopener noreferrer" target="_blank">awesome-zero</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/zero-examples" rel="noopener noreferrer" target="_blank">zero-example</a></li></ul></div><div class="footer__links_5pu0"><ul class="footer__items_3d9P"><li class="footer__title_ulcL">Community</li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/go-zero" rel="noopener noreferrer" target="_blank">GitHub</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://discord.gg/4JQvC5A4Fe" rel="noopener noreferrer" target="_blank">Discord</a></li></ul></div><div class="footer__links_5pu0"><ul class="footer__items_3d9P"><li class="footer__title_ulcL">Links</li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://go-zero.dev/cn" rel="noopener noreferrer" target="_blank">Older Doc</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="/docs/blog/blog">Blog</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/go-zero/blob/master/ROADMAP.md" rel="noopener noreferrer" target="_blank">Roadmap</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://landscape.cncf.io/?selected=go-zero" rel="noopener noreferrer" target="_blank">CNCF</a></li></ul></div><div class="footer__links_5pu0"><ul class="footer__items_3d9P"><li class="footer__title_ulcL">Chat</li><li class="footer__item_K578"><img alt="discord" width="80" src="/img/footer/discord.png" class="footer__img_4fbU"></li></ul></div></div></div><div class="footer__bottom_rXtt"><p class="footer__copyright_9e29">Copyright © 2022 zeromicro</p><ul><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/portal/blob/main/LICENSE">License</a></li></ul><p></p></div></footer></div>
<script src="/assets/js/main.bf2a53e7.js" defer="defer"></script>
</body>
</html>
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3">
<meta httpequiv="x-ua-compatible" content="ie=edge">
<meta property="og:type" content="website">
<meta name="author" content="anqiansong">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link href="https://www.googletagmanager.com" rel="dns-prefetch">
<link href="https://www.google-analytics.com" rel="dns-prefetch">
<link rel="icon" href="https://zero.keson.dev/favicon.png">
<link rel="icon" href="https://zero.keson.dev/favicon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="https://zero.keson.dev/img/icons/apple-180x180.png" sizes="180x180">
<meta name="msapplication-config" content="/browserconfig.xml">
<link rel="sitemap" type="application/xml" href="/sitemap.xml">
<link rel="alternate" type="application/rss+xml" href="/cn/blog/rss.xml" title="go-zero Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/cn/blog/atom.xml" title="go-zero Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XZD0YKV3XQ"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XZD0YKV3XQ",{anonymize_ip:!0})</script>
<link rel="manifest" href="//manifest.webmanifest">
<meta name="theme-color" content="#d14671">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#21222c"><title data-react-helmet="true">go-zero缓存设计之持久层缓存 | go-zero</title><meta data-react-helmet="true" property="og:image" content><meta data-react-helmet="true" name="twitter:image" content><meta data-react-helmet="true" name="twitter:description" content="go-zero 是一个集成了各种工程实践的 web 和 rpc 框架。通过弹性设计保障了大并发服务端的稳定性，经受了充分的实战检验。"><meta data-react-helmet="true" name="twitter:title" content="Introduction | go-zero"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for &quot;Introduction | go-zero&quot;"><meta data-react-helmet="true" property="og:title" content="go-zero缓存设计之持久层缓存 | go-zero"><meta data-react-helmet="true" name="description" content="缓存设计原理"><meta data-react-helmet="true" property="og:description" content="缓存设计原理"><link rel="stylesheet" href="/cn/assets/css/styles.1ca73be8.css">
</head>
<body itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="">
<meta itemprop="description" content="go-zero 是一个集成了各种工程实践的 web 和 rpc 框架。通过弹性设计保障了大并发服务端的稳定性，经受了充分的实战检验。">
<meta itemprop="url" content="https://zero.keson.dev">
<meta itemprop="logo" content="https://zero.keson.dev/img/favicon.png">
<meta itemprop="sameAs" content="https://github.com/zeromicro">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar_wBc8 navbar--light navbar--fixed-top"><div class="navbar__inner inner_Y8Z6"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="brand_AtiA" href="/cn/"><img alt="logo" height="30" src="/cn/img/navbar/logo.svg" class="brand_logo_MqNk"><a class="navbar__brand brand_name_O39n">go-zero</a></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">文档</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/prepare/prepare">环境准备</a></li><li><a class="dropdown__link" href="/cn/docs/quick-start/quick-start">快速开始</a></li><li><a class="dropdown__link" href="/cn/docs/advance/advance">进阶指南</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" sidebarid="goctl">Goctl</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/goctl/installation">安装</a></li><li><a class="dropdown__link" href="/cn/docs/goctl/api">API 指令</a></li><li><a class="dropdown__link" href="/cn/docs/goctl/zrpc">RPC 指令</a></li><li><a class="dropdown__link" href="/cn/docs/goctl/model">Model 指令</a></li><li><a class="dropdown__link" href="/cn/docs/goctl/completion">自动补全</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">生态</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/eco/plugins">Goctl 插件</a></li><li><a class="dropdown__link" href="/cn/docs/eco/editor">编辑器插件</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">社区</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/community/about-us">关于我们</a></li><li><a class="dropdown__link" href="/cn/docs/community/showcase">案例展示</a></li><li><a class="dropdown__link" href="/cn/docs/community/contribute">参与贡献</a></li><li><a class="dropdown__link" href="/cn/docs/community/contributor">贡献人员</a></li><li><a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer" class="dropdown__link">GitHub</a></li><li><a href="https://discord.gg/4JQvC5A4Fe" target="_blank" rel="noopener noreferrer" class="dropdown__link">Discord</a></li></ul></div><a class="navbar__item navbar__link" sidebarid="blog" href="/cn/docs/blog/blog">博客</a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">更多</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/resource-center/learning-resource">资源中心</a></li><li><a href="https://space.bilibili.com/389552232/channel/seriesdetail?sid=2122723" target="_blank" rel="noopener noreferrer" class="dropdown__link">视频教程</a></li><li><a href="https://github.com/zeromicro/go-zero/blob/master/ROADMAP.md" target="_blank" rel="noopener noreferrer" class="dropdown__link">开发路线图</a></li><li><a class="dropdown__link" href="/cn/docs/design/design">设计文档</a></li><li><a class="dropdown__link" href="/cn/docs/faq/troubleshooting">FAQ</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="searchWrapper_f8aU"><div class="navbar__search searchBarContainer_I7kZ"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_Zg7X searchBarLoadingRing_J5Ez"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_CDc6"><kbd class="searchHint_2RRg">ctrl</kbd><kbd class="searchHint_2RRg">K</kbd></div></div></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>中文简体</span></span></a><ul class="dropdown__menu"><li><a href="/docs/blog/cache/redis-cache" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/cn/docs/blog/cache/redis-cache" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">中文简体</a></li></ul></div><a href="https://github.com/zeromicro/go-zero" class="navbar__items navbar__items--right"><img alt="forks" height="30" src="/cn/img/navbar/github.svg" class="star__fork_dBtt"><div class="star_fork_layout_ROo5"><img alt="stars" height="20" src="https://img.shields.io/github/stars/zeromicro/go-zero?style=social" class="star__fork_dBtt"><img alt="forks" height="20" src="https://img.shields.io/github/forks/zeromicro/go-zero?style=social" class="star__fork_dBtt"></div></a><div class="react-toggle themeToggleInHeading_b3Mq react-toggle--checked react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_iYfV" style="margin-left:2px">🌙</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV" style="margin-left:1px">☀</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand brand_AtiA" href="/cn/">go-zero</a><div class="react-toggle themeToggleInSidebar_qGRI react-toggle--checked react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_iYfV" style="margin-left:2px">🌙</span></div><div class="react-toggle-track-x"><span class="toggle_iYfV" style="margin-left:1px">☀</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a href="#" role="button" class="menu__link menu__link--sublist"><span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" style="vertical-align:text-bottom;margin-right:5px"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>Languages</span></span></a><ul class="menu__list"><li class="menu__list-item"><a href="/docs/blog/cache/redis-cache" target="_self" rel="noopener noreferrer" class="menu__link" style="text-transform:capitalize">English</a></li><li class="menu__list-item"><a href="/cn/docs/blog/cache/redis-cache" target="_self" rel="noopener noreferrer" class="menu__link dropdown__link--active" style="text-transform:capitalize">中文简体</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">文档</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/cn/docs/prepare/prepare">环境准备</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/quick-start/quick-start">快速开始</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/advance/advance">进阶指南</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist" sidebarid="goctl">Goctl</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/cn/docs/goctl/installation">安装</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/goctl/api">API 指令</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/goctl/zrpc">RPC 指令</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/goctl/model">Model 指令</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/goctl/completion">自动补全</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">生态</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/cn/docs/eco/plugins">Goctl 插件</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/eco/editor">编辑器插件</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">社区</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/cn/docs/community/about-us">关于我们</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/community/showcase">案例展示</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/community/contribute">参与贡献</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/community/contributor">贡献人员</a></li><li class="menu__list-item"><a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://discord.gg/4JQvC5A4Fe" target="_blank" rel="noopener noreferrer" class="menu__link">Discord</a></li></ul></li><li class="menu__list-item"><a class="menu__link" sidebarid="blog" href="/cn/docs/blog/blog">博客</a></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">更多</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/cn/docs/resource-center/learning-resource">资源中心</a></li><li class="menu__list-item"><a href="https://space.bilibili.com/389552232/channel/seriesdetail?sid=2122723" target="_blank" rel="noopener noreferrer" class="menu__link">视频教程</a></li><li class="menu__list-item"><a href="https://github.com/zeromicro/go-zero/blob/master/ROADMAP.md" target="_blank" rel="noopener noreferrer" class="menu__link">开发路线图</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/design/design">设计文档</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/faq/troubleshooting">FAQ</a></li></ul></li></ul></div></div></div></nav><div class="wrapper_DIJ0"><div class="doc_D+rh"><div class="doc__sidebar_gVFN" role="complementary"><div class="sidebar_LIo8"><div class="menu menu--responsive thin-scrollbar menu_oAhv"><button aria-label="打开" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_nrF-" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" href="/cn/docs/blog/blog">博客</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">服务治理</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/governance/bloom">bloom</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/governance/breaker-algorithms">熔断原理与实现</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/governance/loadshedding">服务自适应降载保护设计</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/governance/periodlimit">periodlimit</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/governance/tokenlimit">tokenlimit</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u menu__link--sublist menu__link--active" href="#!">缓存设计</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="0" href="/cn/docs/blog/cache/cache">DB缓存机制</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menuLink_Zq3u menu__link--active active" tabindex="0" href="/cn/docs/blog/cache/redis-cache">go-zero缓存设计之持久层缓存</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="0" href="/cn/docs/blog/cache/business-cache">go-zero缓存设计之业务层缓存</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="0" href="/cn/docs/blog/cache/collection">通过 collection.Cache 进行缓存</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">组件介绍</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/tool/executors">executors</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/tool/keywords">高效的关键词替换和敏感词过滤工具</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/tool/logx">logx</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">并发编程</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/concurrency/fx">数据的流处理利器</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/concurrency/mapreduce">通过MapReduce降低服务响应时间</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/concurrency/stream">流数据处理利器</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/concurrency/redis-lock">redis lock</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/concurrency/sharedcalls">防止缓存击穿之进程内共享调用</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">原理介绍</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/principle/timing-wheel">TimingWheel</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">案例展示</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/showcase/shorturl">快速构建高并发微服务</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/showcase/zrpc">企业级RPC框架zRPC</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/showcase/mysql">mysql</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/showcase/mapping">文本序列化和反序列化</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/showcase/datacenter">我是如何用 go-zero 实现一个中台系统</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/showcase/go-queue">go-zero 分布式定时任务</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/showcase/go-zero-looklook">使用go-zero开发一个旅游系统go-zero-looklook</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/showcase/metric">基于prometheus的微服务指标监控</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">线上交流</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/share/online-exchange">10月3日线上交流问题汇总</a></li></ul></li></ul></div></div></div><main class="doc__main_VklL"><div class="padding-vert--lg container doc__item-wrapper_FIxd"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><header><h1 class="docTitle_-X99">go-zero缓存设计之持久层缓存</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="缓存设计原理"></a>缓存设计原理<a class="hash-link" href="#缓存设计原理" title="跳转到标题">#</a></h2><p>我们对缓存是只删除，不做更新，一旦DB里数据出现修改，我们就会直接删除对应的缓存，而不是去更新。</p><p>我们看看删除缓存的顺序怎样才是正确的。</p><ul><li>先删除缓存，再更新DB</li></ul><p><img alt="redis-cache-01" src="/cn/assets/images/redis-cache-01-c05028cdbb789f3f929f0c0dd8a39c92.png"></p><p>我们看两个并发请求的情况，A请求需要更新数据，先删除了缓存，然后B请求来读取数据，此时缓存没有数据，就会从DB加载数据并写回缓存，然后A更新了DB，那么此时缓存内的数据就会一直是脏数据，直到缓存过期或者有新的更新数据的请求。如图</p><p><img alt="redis-cache-02" src="/cn/assets/images/redis-cache-02-5c1917bc768c456848139d89b935cd86.png"></p><ul><li><p>先更新DB，再删除缓存</p><p>  <img alt="redis-cache-03" src="/cn/assets/images/redis-cache-03-1f8bf52294d76e34b9886f275986eb6e.png"></p></li></ul><p>A请求先更新DB，然后B请求来读取数据，此时返回的是老数据，此时可以认为是A请求还没更新完，最终一致性，可以接受，然后A删除了缓存，后续请求都会拿到最新数据，如图
<img alt="redis-cache-04" src="/cn/assets/images/redis-cache-04-54b4f221ab656d99239263735576e561.png"></p><p>让我们再来看一下正常的请求流程：</p><ul><li>第一个请求更新DB，并删除了缓存</li><li>第二个请求读取缓存，没有数据，就从DB读取数据，并回写到缓存里</li><li>后续读请求都可以直接从缓存读取
<img alt="redis-cache-05" src="/cn/assets/images/redis-cache-05-f1847d60569f085c07e97d9d3e7482e4.png"></li></ul><p>我们再看一下DB查询有哪些情况，假设行记录里有ABCDEFG七列数据：</p><ul><li>只查询部分列数据的请求，比如请求其中的ABC，CDE或者EFG等，如图
<img alt="redis-cache-06" src="/cn/assets/images/redis-cache-06-e590e267d43fcbae67d43f6507258033.png"></li><li>查询单条完整行记录，如图
<img alt="redis-cache-07" src="/cn/assets/images/redis-cache-07-af6d71ea0b1908b83a0a0c1923e78451.png"></li><li>查询多条行记录的部分或全部列，如图
<img alt="redis-cache-08" src="/cn/assets/images/redis-cache-08-98313c2668eb5457e165ae7c763ae4f7.png"></li></ul><p>对于上面三种情况，首先，我们不用部分查询，因为部分查询没法缓存，一旦缓存了，数据有更新，没法定位到有哪些数据需要删除；其次，对于多行的查询，根据实际场景和需要，我们会在业务层建立对应的从查询条件到主键的映射；而对于单行完整记录的查询，go-zero 内置了完整的缓存管理方式。所以核心原则是：<strong>go-zero 缓存的一定是完整的行记录</strong>。</p><p>下面我们来详细介绍 go-zero 内置的三种场景的缓存处理方式：</p><ul><li>基于主键的缓存<div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI text"><div tabindex="0" class="prism-code language-text codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">PRIMARY KEY (`id`)</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div></li></ul><p>这种相对来讲是最容易处理的缓存，只需要在 redis 里用 primary key 作为 key 来缓存行记录即可。</p><ul><li>基于唯一索引的缓存
<img alt="redis-cache-09" src="data:image/webp;base64,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"></li></ul><p>在做基于索引的缓存设计的时候我借鉴了 database 索引的设计方法，在 database 设计里，如果通过索引去查数据时，引擎会先在 索引-&gt;主键 的 tree 里面查找到主键，然后再通过主键去查询行记录，就是引入了一个间接层去解决索引到行记录的对应问题。在 go-zero 的缓存设计里也是同样的原理。</p><p>基于索引的缓存又分为单列唯一索引和多列唯一索引：</p><p>但是对于 go-zero 来说，单列和多列只是生成缓存 key 的方式不同而已，背后的控制逻辑是一样的。然后 go-zero 内置的缓存管理就比较好的控制了数据一致性问题，同时也内置防止了缓存的击穿、穿透、雪崩问题（这些在 gopherchina 大会上分享的时候仔细讲过，见后续 gopherchina 分享视频）。</p><p>另外，go-zero 内置了缓存访问量、访问命中率统计，如下所示：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI text"><div tabindex="0" class="prism-code language-text codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">dbcache(sqlc) - qpm: 5057, hit_ratio: 99.7%, hit: 5044, miss: 13, db_fails: 0</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>可以看到比较详细的统计信息，便于我们来分析缓存的使用情况，对于缓存命中率极低或者请求量极小的情况，我们就可以去掉缓存了，这样也可以降低成本。</p><ul><li><p>单列唯一索引如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI text"><div tabindex="0" class="prism-code language-text codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">UNIQUE KEY `product_idx` (`product`)</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div></li><li><p>多列唯一索引如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI text"><div tabindex="0" class="prism-code language-text codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">UNIQUE KEY `vendor_product_idx` (`vendor`, `product`)</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="缓存代码解读"></a>缓存代码解读<a class="hash-link" href="#缓存代码解读" title="跳转到标题">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="1基于主键的缓存逻辑"></a>1.基于主键的缓存逻辑<a class="hash-link" href="#1基于主键的缓存逻辑" title="跳转到标题">#</a></h3><p><img alt="redis-cache-10" src="/cn/assets/images/redis-cache-10-cb86054e7a45b09579b82edb6da98613.png"></p><p>具体实现代码如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cc CachedConn</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">QueryRow</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">v </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> key </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> query QueryFn</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> cc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">cache</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Take</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">v</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">v </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">query</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">db</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>这里的 <code>Take</code> 方法是先从缓存里去通过 <code>key</code> 拿数据，如果拿到就直接返回，如果拿不到，那么就通过 <code>query</code> 方法去 <code>DB</code> 读取完整行记录并写回缓存，然后再返回数据。整个逻辑还是比较简单易懂的。</p><p>我们详细看看 <code>Take</code> 的实现：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">c cacheNode</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">Take</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">v </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> key </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> query </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">v </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">doTake</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">v</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> query</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">v </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">SetCache</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p><code>Take</code> 的逻辑如下：</p><ul><li>用 key 从缓存里查找数据</li><li>如果找到，则返回数据</li><li>如果找不到，用 query 方法去读取数据</li><li>读到后调用 c.SetCache(key, v) 设置缓存</li></ul><p>其中的 <code>doTake</code> 代码和解释如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4">// v - 需要读取的数据对象</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4">// key - 缓存key</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4">// query - 用来从DB读取完整数据的方法</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4">// cacheVal - 用来写缓存的方法</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">c cacheNode</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">doTake</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">v </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> key </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> query </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">v </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  cacheVal </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">v </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// 用barrier来防止缓存击穿，确保一个进程内只有一个请求去加载key对应的数据</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  val</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> fresh</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">barrier</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">DoEx</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// 从cache里读取数据</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">doGetCache</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#6272a4">// 如果是预先放进来的placeholder（用来防止缓存穿透）的，那么就返回预设的errNotFound</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#6272a4">// 如果是未知错误，那么就直接返回，因为我们不能放弃缓存出错而直接把所有请求去请求DB，</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#6272a4">// 这样在高并发的场景下会把DB打挂掉的</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">==</span><span class="token plain"> errPlaceholder </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">errNotFound</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">else</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">errNotFound </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#6272a4">// why we just return the error instead of query from db,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#6272a4">// because we don&#x27;t allow the disaster pass to the DBs.</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#6272a4">// fail fast, in case we bring down the dbs.</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#6272a4">// 请求DB</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#6272a4">// 如果返回的error是errNotFound，那么我们就需要在缓存里设置placeholder，防止缓存穿透</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">query</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">v</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">==</span><span class="token plain"> c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">errNotFound </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">setCacheWithNotFound</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">          logx</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Error</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">errNotFound</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">else</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#6272a4">// 统计DB失败</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">stat</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">IncrementDbFails</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#6272a4">// 把数据写入缓存</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">cacheVal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">v</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        logx</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Error</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// 返回json序列化的数据</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> jsonx</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Marshal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">v</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> err</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> fresh </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// got the result from previous ongoing query</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">stat</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">IncrementTotal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">stat</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">IncrementHit</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// 把数据写入到传入的v对象里</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> jsonx</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Unmarshal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">val</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token builtin" style="color:#bd93f9">byte</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="2-基于唯一索引的缓存逻辑"></a>2. 基于唯一索引的缓存逻辑<a class="hash-link" href="#2-基于唯一索引的缓存逻辑" title="跳转到标题">#</a></h3><p>因为这块比较复杂，所以我用不同颜色标识出来了响应的代码块和逻辑，<code>block 2</code> 其实跟基于主键的缓存是一样的，这里主要讲 <code>block 1</code> 的逻辑。
<img alt="redis-cache-11" src="/cn/assets/images/redis-cache-11-c2989ee89c9f5f204d294bbed81f1bad.webp"></p><p>代码块的 block 1 部分分为两种情况：</p><ul><li><p>通过索引能够从缓存里找到主键，此时就直接用主键走 <code>block 2</code> 的逻辑了，后续同上面基于主键的缓存逻辑</p></li><li><p>通过索引无法从缓存里找到主键</p><ul><li>通过索引从DB里查询完整行记录，如有 <code>error</code>，返回</li><li>查到完整行记录后，会把主键到完整行记录的缓存和索引到主键的缓存同时写到 <code>redis</code> 里</li><li>返回所需的行记录数据</li></ul></li></ul><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token comment" style="color:#6272a4">// v - 需要读取的数据对象</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4">// key - 通过索引生成的缓存key</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4">// keyer - 用主键生成基于主键缓存的key的方法</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4">// indexQuery - 用索引从DB读取完整数据的方法，需要返回主键</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token comment" style="color:#6272a4">// primaryQuery - 用主键从DB获取完整数据的方法</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cc CachedConn</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">QueryRowIndex</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">v </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> key </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> keyer </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">primary </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  indexQuery IndexQueryFn</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> primaryQuery PrimaryQueryFn</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">var</span><span class="token plain"> primaryKey </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">var</span><span class="token plain"> found </span><span class="token builtin" style="color:#bd93f9">bool</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// 先通过索引查询缓存，看是否有索引到主键的缓存</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> cc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">cache</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">TakeWithExpire</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">primaryKey</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> key</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">val </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> expire time</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Duration</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">err </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// 如果没有索引到主键的缓存，那么就通过索引查询完整数据</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    primaryKey</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">indexQuery</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">db</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// 通过索引查询到了完整数据，设置found，后面直接使用，不需要再从缓存读取数据了</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    found </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">true</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// 将主键到完整数据的映射保存到缓存里，TakeWithExpire方法已经将索引到主键的映射保存到缓存了</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> cc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">cache</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">SetCacheWithExpire</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token function" style="color:#8be9fd">keyer</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">primaryKey</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> expire</span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain">cacheSafeGapBetweenIndexAndPrimary</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> err</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// 已经通过索引找到了数据，直接返回即可</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> found </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// 通过主键从缓存读取数据，如果缓存没有，通过primaryQuery方法从DB读取并回写缓存再返回数据</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> cc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">cache</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Take</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">v</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">keyer</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">primaryKey</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">v </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">primaryQuery</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">db</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> primaryKey</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>我们来看一个实际的例子</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">m </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">defaultUserModel</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">FindOneByUser</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">user </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">User</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">var</span><span class="token plain"> resp User</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// 生成基于索引的key</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  indexKey </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Sprintf</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;%s%v&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> cacheUserPrefix</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  err </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> m</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">QueryRowIndex</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">resp</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> indexKey</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// 基于主键生成完整数据缓存的key</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">primary </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Sprintf</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;user#%v&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> primary</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// 基于索引的DB查询方法</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">conn sqlx</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">SqlConn</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> v </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">i </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> e </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      query </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Sprintf</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;select %s from %s where user = ? limit 1&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> userRows</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">table</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">QueryRow</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">resp</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> query</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> user</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> resp</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Id</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// 基于主键的DB查询方法</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">conn sqlx</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">SqlConn</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> v</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> primary </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      query </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Sprintf</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;select %s from %s where id = ?&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> userRows</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">table</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">QueryRow</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">resp</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> query</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> primary</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// 错误处理，需要判断是否返回的是sqlc.ErrNotFound，如果是，我们用本package定义的ErrNotFound返回</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// 避免使用者感知到有没有使用缓存，同时也是对底层依赖的隔离</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token keyword" style="color:#ff79c6">switch</span><span class="token plain"> err </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">case</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">resp</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">case</span><span class="token plain"> sqlc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ErrNotFound</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> ErrNotFound</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">default</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>所有上面这些缓存的自动管理代码都是可以通过 <a href="/cn/docs/goctl/goctl">goctl</a> 自动生成的，我们团队内部 <code>CRUD</code> 和缓存基本都是通过 <a href="/cn/docs/goctl/goctl">goctl</a> 自动生成的，可以节省大量开发时间，并且缓存代码本身也是非常容易出错的，即使有很好的代码经验，也很难每次完全写对，所以我们推荐尽可能使用自动的缓存代码生成工具去避免错误。</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/anqiansong/zeromicro/blob/main/docs/blog/cache/redis-cache.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col text--right"><em><small>最后更新 日期： <time datetime="2022-04-30T06:05:09.000Z" class="lastUpdatedDate_nN9m">4/30/2022</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="文档页面导航"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/cn/docs/blog/cache/cache"><div class="pagination-nav__sublabel">上一篇</div><div class="pagination-nav__label">« DB缓存机制</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/cn/docs/blog/cache/business-cache"><div class="pagination-nav__sublabel">下一篇</div><div class="pagination-nav__label">go-zero缓存设计之业务层缓存 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#缓存设计原理" class="table-of-contents__link">缓存设计原理</a></li><li><a href="#缓存代码解读" class="table-of-contents__link">缓存代码解读</a><ul><li><a href="#1基于主键的缓存逻辑" class="table-of-contents__link">1.基于主键的缓存逻辑</a></li><li><a href="#2-基于唯一索引的缓存逻辑" class="table-of-contents__link">2. 基于唯一索引的缓存逻辑</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer_rm3y section_bQ6r"><div class="footer__inner_OWoZ section--inner_6-fB"><div class="footer__column_+a5z footer__column--left_4bpB"><div><img alt="go-zero logo" class="footer__logo_ayM4" height="27" src="/cn/img/footer/go-zero.svg" title="go-zero" width="108"><img alt="stars" height="27" src="https://img.shields.io/github/stars/zeromicro/go-zero?style=social" class="footer__logo_ayM4"><img alt="forks" height="27" src="https://img.shields.io/github/forks/zeromicro/go-zero?style=social" class="footer__logo_ayM4"></div><p class="footer__tagline_b1u+">go-zero 是一个集成了各种工程实践的 web 和 rpc 框架</p><a class="footer__github_okz3 button_f7Ff button--icon_q89D button--secondary_x3vq button--xsmall_fwzy" href="https://github.com/zeromicro/go-zero" rel="noopener noreferrer" target="_blank"><img alt="GitHub logo" height="22" src="/cn/img/github.svg" title="GitHub" width="22">Star us on GitHub</a></div><div class="footer__column_+a5z footer__column--right_FGdI"><div class="footer__links_5pu0"><ul class="footer__items_3d9P"><li class="footer__title_ulcL">zeromicro</li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/zero-api" rel="noopener noreferrer" target="_blank">zero-api</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/go-queue" rel="noopener noreferrer" target="_blank">go-queue</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/awesome-zero" rel="noopener noreferrer" target="_blank">awesome-zero</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/zero-examples" rel="noopener noreferrer" target="_blank">zero-example</a></li></ul></div><div class="footer__links_5pu0"><ul class="footer__items_3d9P"><li class="footer__title_ulcL">社区</li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/go-zero" rel="noopener noreferrer" target="_blank">GitHub</a></li><li class="footer__item_K578"><span></span></li></ul></div><div class="footer__links_5pu0"><ul class="footer__items_3d9P"><li class="footer__title_ulcL">友情链接</li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://go-zero.dev/cn" rel="noopener noreferrer" target="_blank">旧文档</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="/cn/blog/blog">博客</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/go-zero/blob/master/ROADMAP.md" rel="noopener noreferrer" target="_blank">开发路线图</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://landscape.cncf.io/?selected=go-zero" rel="noopener noreferrer" target="_blank">CNCF</a></li></ul></div><div class="footer__links_5pu0"><ul class="footer__items_3d9P"><li class="footer__title_ulcL">微信二维码</li><li class="footer__item_K578"><img alt="微信群" width="80" src="https://raw.githubusercontent.com/zeromicro/zero-doc/main/doc/images/wechat.jpg" class="footer__img_4fbU"></li></ul></div></div></div><div class="footer__bottom_rXtt"><p class="footer__copyright_9e29">Copyright © 2022 zeromicro</p><ul><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/go-zero/blob/master/LICENSE">License</a></li></ul><p></p></div></footer></div>
<script src="/cn/assets/js/main.b144317f.js" defer="defer"></script>
</body>
</html>
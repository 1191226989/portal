"use strict";(self.webpackChunkgo_zero=self.webpackChunkgo_zero||[]).push([[6571],{3905:function(e,r,n){n.d(r,{Zo:function(){return p},kt:function(){return d}});var t=n(7294);function a(e,r,n){return r in e?Object.defineProperty(e,r,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[r]=n,e}function c(e,r){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);r&&(t=t.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,t)}return n}function o(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?c(Object(n),!0).forEach((function(r){a(e,r,n[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):c(Object(n)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))}))}return e}function s(e,r){if(null==e)return{};var n,t,a=function(e,r){if(null==e)return{};var n,t,a={},c=Object.keys(e);for(t=0;t<c.length;t++)n=c[t],r.indexOf(n)>=0||(a[n]=e[n]);return a}(e,r);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(t=0;t<c.length;t++)n=c[t],r.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var i=t.createContext({}),l=function(e){var r=t.useContext(i),n=r;return e&&(n="function"==typeof e?e(r):o(o({},r),e)),n},p=function(e){var r=l(e.components);return t.createElement(i.Provider,{value:r},e.children)},u={inlineCode:"code",wrapper:function(e){var r=e.children;return t.createElement(t.Fragment,{},r)}},m=t.forwardRef((function(e,r){var n=e.components,a=e.mdxType,c=e.originalType,i=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),m=l(n),d=a,g=m["".concat(i,".").concat(d)]||m[d]||u[d]||c;return n?t.createElement(g,o(o({ref:r},p),{},{components:n})):t.createElement(g,o({ref:r},p))}));function d(e,r){var n=arguments,a=r&&r.mdxType;if("string"==typeof e||a){var c=n.length,o=new Array(c);o[0]=m;var s={};for(var i in r)hasOwnProperty.call(r,i)&&(s[i]=r[i]);s.originalType=e,s.mdxType="string"==typeof e?e:a,o[1]=s;for(var l=2;l<c;l++)o[l]=n[l];return t.createElement.apply(null,o)}return t.createElement.apply(null,n)}m.displayName="MDXCreateElement"},6775:function(e,r,n){n.r(r),n.d(r,{default:function(){return u},frontMatter:function(){return s},metadata:function(){return i},toc:function(){return l}});var t=n(7462),a=n(3366),c=(n(7294),n(3905)),o=["components"],s={},i={unversionedId:"advance/rpc-call",id:"advance/rpc-call",isDocsHomePage:!1,title:"RPC Implement & Call",description:"In a large system, there must be data transfer between multiple subsystems (services). If there is data transfer, you need a communication method. You can choose the simplest http for communication or rpc service for communication.",source:"@site/docs/advance/rpc-call.md",sourceDirName:"advance",slug:"/advance/rpc-call",permalink:"/docs/advance/rpc-call",editUrl:"https://github.com/anqiansong/zeromicro/blob/main/docs/advance/rpc-call.md",version:"current",lastUpdatedAt:1651298709,formattedLastUpdatedAt:"4/30/2022",frontMatter:{},sidebar:"docs",previous:{title:"Middleware",permalink:"/docs/advance/middleware"},next:{title:"Error Handling",permalink:"/docs/advance/error-handle"}},l=[{value:"Scenes",id:"scenes",children:[]},{value:"rpc service writing",id:"rpc-service-writing",children:[]},{value:"Use rpc",id:"use-rpc",children:[]},{value:"Start and verify the service",id:"start-and-verify-the-service",children:[]}],p={toc:l};function u(e){var r=e.components,n=(0,a.Z)(e,o);return(0,c.kt)("wrapper",(0,t.Z)({},p,n,{components:r,mdxType:"MDXLayout"}),(0,c.kt)("p",null,"In a large system, there must be data transfer between multiple subsystems (services). If there is data transfer, you need a communication method. You can choose the simplest http for communication or rpc service for communication.\nIn go-zero, we use zrpc to communicate between services, which is based on grpc."),(0,c.kt)("h2",{id:"scenes"},"Scenes"),(0,c.kt)("p",null,"In the front, we have improved the interface protocol for user login, user query of books, etc., but the user did not do any user verification when querying the book. If the current user is a non-existent user, we do not allow him to view book information.\nFrom the above information, we can know that the user service needs to provide a method to obtain user information for use by the search service, so we need to create a user rpc service and provide a getUser method."),(0,c.kt)("h2",{id:"rpc-service-writing"},"rpc service writing"),(0,c.kt)("ul",null,(0,c.kt)("li",{parentName:"ul"},(0,c.kt)("p",{parentName:"li"},"Compile the proto file"),(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/rpc/user.proto\n")),(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-protobuf"},'syntax = "proto3";\n\npackage user;\n\noption go_package = "./user";\n\nmessage IdReq{\n  int64 id = 1;\n}\n\nmessage UserInfoReply{\n  int64 id = 1;\n  string name = 2;\n  string number = 3;\n  string gender = 4;\n}\n\nservice user {\n  rpc getUser(IdReq) returns(UserInfoReply);\n}\n')),(0,c.kt)("ul",{parentName:"li"},(0,c.kt)("li",{parentName:"ul"},"Generate rpc service code",(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd service/user/rpc\n$ goctl rpc protoc user.proto --go_out=./types --go-grpc_out=./types --zrpc_out=.\n")))))),(0,c.kt)("blockquote",null,(0,c.kt)("p",{parentName:"blockquote"},"[!TIPS]","\nIf the installed version of ",(0,c.kt)("inlineCode",{parentName:"p"},"protoc-gen-go")," is larger than 1.4.0, it is recommended to add ",(0,c.kt)("inlineCode",{parentName:"p"},"go_package")," to the proto file")),(0,c.kt)("ul",null,(0,c.kt)("li",{parentName:"ul"},(0,c.kt)("p",{parentName:"li"},"Add configuration and improve yaml configuration items"),(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/rpc/internal/config/config.go\n")),(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-go"},"type Config struct {\n    zrpc.RpcServerConf\n    Mysql struct {\n        DataSource string\n    }\n    CacheRedis cache.CacheConf\n}\n")),(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim /service/user/rpc/etc/user.yaml\n")),(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-yaml"},"Name: user.rpc\nListenOn: 127.0.0.1:8080\nEtcd:\n  Hosts:\n    - $etcdHost\n  Key: user.rpc\nMysql:\n  DataSource: $user:$password@tcp($url)/$db?charset=utf8mb4&parseTime=true&loc=Asia%2FShanghai\nCacheRedis:\n  - Host: $host\n    Pass: $pass\n    Type: node  \n")),(0,c.kt)("blockquote",{parentName:"li"},(0,c.kt)("p",{parentName:"blockquote"},"[!TIP]","\n$user: mysql database user"),(0,c.kt)("p",{parentName:"blockquote"},"$password: mysql database password"),(0,c.kt)("p",{parentName:"blockquote"},"$url: mysql database connection address"),(0,c.kt)("p",{parentName:"blockquote"},"$db: mysql database db name, that is, the database where the user table is located"),(0,c.kt)("p",{parentName:"blockquote"},"$host: Redis connection address Format: ip:port, such as: 127.0.0.1:6379"),(0,c.kt)("p",{parentName:"blockquote"},"$pass: redis password"),(0,c.kt)("p",{parentName:"blockquote"},"$etcdHost: etcd connection address, format: ip:port, such as: 127.0.0.1:2379"),(0,c.kt)("p",{parentName:"blockquote"},"For more configuration information, please refer to ",(0,c.kt)("a",{parentName:"p",href:"../configuration/rpc"},"rpc configuration introduction")))),(0,c.kt)("li",{parentName:"ul"},(0,c.kt)("p",{parentName:"li"},"Add resource dependency"),(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/user/rpc/internal/svc/servicecontext.go  \n")),(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-go"},"type ServiceContext struct {\n    Config    config.Config\n    UserModel model.UserModel\n}\n\nfunc NewServiceContext(c config.Config) *ServiceContext {\n    conn := sqlx.NewMysql(c.Mysql.DataSource)\n    return &ServiceContext{\n        Config: c,\n        UserModel: model.NewUserModel(conn, c.CacheRedis),\n    }\n}\n"))),(0,c.kt)("li",{parentName:"ul"},(0,c.kt)("p",{parentName:"li"},"Add rpc logic"),(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-shell"},"$ service/user/rpc/internal/logic/getuserlogic.go\n")),(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-go"},"func (l *GetUserLogic) GetUser(in *user.IdReq) (*user.UserInfoReply, error) {\n    one, err := l.svcCtx.UserModel.FindOne(in.Id)\n    if err != nil {\n        return nil, err\n    }\n    \n    return &user.UserInfoReply{\n        Id:     one.Id,\n        Name:   one.Name,\n        Number: one.Number,\n        Gender: one.Gender,\n    }, nil\n}\n")))),(0,c.kt)("h2",{id:"use-rpc"},"Use rpc"),(0,c.kt)("p",null,"Next we call user rpc in the search service"),(0,c.kt)("ul",null,(0,c.kt)("li",{parentName:"ul"},"Add UserRpc configuration and yaml configuration items",(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/search/api/internal/config/config.go\n")),(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-go"},"type Config struct {\n    rest.RestConf\n    Auth struct {\n        AccessSecret string\n        AccessExpire int64\n    }\n    UserRpc zrpc.RpcClientConf\n}\n")),(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/search/api/etc/search-api.yaml\n")),(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-yaml"},"Name: search-api\nHost: 0.0.0.0\nPort: 8889\nAuth:\n  AccessSecret: $AccessSecret\n  AccessExpire: $AccessExpire\nUserRpc:\n  Etcd:\n    Hosts:\n      - $etcdHost\n    Key: user.rpc\n")),(0,c.kt)("blockquote",{parentName:"li"},(0,c.kt)("p",{parentName:"blockquote"},"[!TIP]","\n$AccessSecret: This value must be consistent with the one declared in the user api."),(0,c.kt)("p",{parentName:"blockquote"},"$AccessExpire: Valid period"),(0,c.kt)("p",{parentName:"blockquote"},"$etcdHost\uff1a etcd connection address"),(0,c.kt)("p",{parentName:"blockquote"},"The ",(0,c.kt)("inlineCode",{parentName:"p"},"Key")," in etcd must be consistent with the Key in the user rpc service configuration"))),(0,c.kt)("li",{parentName:"ul"},"Add dependency",(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim service/search/api/internal/svc/servicecontext.go\n")),(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-go"},"type ServiceContext struct {\n    Config  config.Config\n    Example rest.Middleware\n    UserRpc user.User\n}\n\nfunc NewServiceContext(c config.Config) *ServiceContext {\n    return &ServiceContext{\n        Config:  c,\n        Example: middleware.NewExampleMiddleware().Handle,\n        UserRpc: user.NewUser(zrpc.MustNewClient(c.UserRpc)),\n    }\n}\n"))),(0,c.kt)("li",{parentName:"ul"},"Supplementary logic",(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-shell"},"$ vim /service/search/api/internal/logic/searchlogic.go\n")),(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-go"},'func (l *SearchLogic) Search(req types.SearchReq) (*types.SearchReply, error) {\n    userIdNumber := json.Number(fmt.Sprintf("%v", l.ctx.Value("userId")))\n    logx.Infof("userId: %s", userIdNumber)\n    userId, err := userIdNumber.Int64()\n    if err != nil {\n        return nil, err\n    }\n    \n    // use user rpc\n    _, err = l.svcCtx.UserRpc.GetUser(l.ctx, &user.IdReq{\n        Id: userId,\n    })\n    if err != nil {\n        return nil, err\n    }\n\n    return &types.SearchReply{\n        Name:  req.Name,\n        Count: 100,\n    }, nil\n}\n')))),(0,c.kt)("h2",{id:"start-and-verify-the-service"},"Start and verify the service"),(0,c.kt)("ul",null,(0,c.kt)("li",{parentName:"ul"},"Start etcd, redis, mysql"),(0,c.kt)("li",{parentName:"ul"},"Start user rpc",(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd service/user/rpc\n$ go run user.go -f etc/user.yaml\n")),(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-text"},"Starting rpc server at 127.0.0.1:8080...\n"))),(0,c.kt)("li",{parentName:"ul"},"Start search api")),(0,c.kt)("pre",null,(0,c.kt)("code",{parentName:"pre",className:"language-shell"},"$ cd service/search/api\n$ go run search.go -f etc/search-api.yaml\n")),(0,c.kt)("ul",null,(0,c.kt)("li",{parentName:"ul"},"Verification Service",(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-shell"},"$ curl -i -X GET \\\n  'http://127.0.0.1:8889/search/do?name=%E8%A5%BF%E6%B8%B8%E8%AE%B0' \\\n  -H 'authorization: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2MTI4NjcwNzQsImlhdCI6MTYxMjc4MDY3NCwidXNlcklkIjoxfQ.JKa83g9BlEW84IiCXFGwP2aSd0xF3tMnxrOzVebbt80'\n")),(0,c.kt)("pre",{parentName:"li"},(0,c.kt)("code",{parentName:"pre",className:"language-text"},'HTTP/1.1 200 OK\nContent\n-Type: application/json\nDate: Tue, 09 Feb 2021 06:05:52 GMT\nContent-Length: 32\n\n{"name":"xiyouji","count":100}\n')))))}u.isMDXComponent=!0}}]);